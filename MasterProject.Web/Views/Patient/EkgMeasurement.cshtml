@using MasterProject.Core.Enums
@model MasterProject.Web.Models.MeasurementViewModel

@{
    ViewBag.Title = "Pomiar EKG";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<main role="main" class="col-md-9 ml-sm-auto col-lg-10 pt-3 px-4">
    <div class="container">
        <div id="smallNav">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Home")">Strona główna</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("PatientList", "Patient")">Lista pacjentów</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("EditPatient", "Patient", new { id = Model.Id })">Edycja konta</a>
                </li>
                <li class="breadcrumb-item">
                    <a>
                        <b>Pomiar EKG</b>
                    </a>
                </li>
            </ol>
        </div>

        <div id="chartContainer" style="height: 600px"></div>

        <div class="row">
            <div class="col">
                <button type="button" class="btn btn-primary" style="width: 100px;" onClick="reset()">Reset</button>
            </div>
            <div class="col text-center">
                <button type="button" class="btn btn-danger" style="width: 100px;" onClick="stop()">Stop</button>
                <button type="button" class="btn btn-success" style="width: 100px;" onClick="start()">Start</button>
            </div>
            <div class="col">
            </div>
        </div>
    </div>
</main>

@section scripts{
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <script type="text/javascript">
        var xAxisStripLinesArray = [];
        var yAxisStripLinesArray = [];
        var dps = [];
        var chart = new CanvasJS.Chart("chartContainer",
            {
                zoomEnabled: true,
                exportEnabled: true,
                title: {
                    text: "Raport EKG"
                },
                subtitles: [
                    {
                        text: "Imię i nazwisko: @Model.Name",
                        horizontalAlign: "left"
                    },
                    {
                        text: "Wiek: @Model.Age",
                        horizontalAlign: "left"
                    },
                    {
                        text: "Podpis lekarza",
                        horizontalAlign: "right",
                        verticalAlign: "bottom"
                    }
                ],
                axisY: {
                    stripLines: yAxisStripLinesArray,
                    gridThickness: 2,
                    gridColor: "#DC74A5",
                    lineColor: "#DC74A5",
                    tickColor: "#DC74A5",
                    labelFontColor: "#DC74A5"
                },
                axisX: {
                    stripLines: xAxisStripLinesArray,
                    gridThickness: 2,
                    gridColor: "#DC74A5",
                    lineColor: "#DC74A5",
                    tickColor: "#DC74A5",
                    labelFontColor: "#DC74A5"
                },
                data: [
                    {
                        type: "spline",
                        color: "black",
                        dataPoints: dps
                    }
                ]
            });
        var interval;

        window.onload = function() {
            addStripLines();
            chart.render();
        };

        function addStripLines() {
            for (var i = 0; i < 4500; i = i + 100) {
                if (i % 1000 != 0)
                    yAxisStripLinesArray.push({ value: i, thickness: 0.7, color: "#DC74A5" });
            }
            for (var i = 0; i < 3000; i = i + 20) {
                if (i % 200 != 0)
                    xAxisStripLinesArray.push({ value: i, thickness: 0.7, color: "#DC74A5" });
            }
        }

        var updateChart = function() {
            var yVal = 0;
            $.ajax({
                type: 'POST',
                url: '@Url.Action("ReadData", new { deviceTypeId = (int)DeviceTypes.Ekg })',
                async: false,
                dataType: 'json',
                success: function(result) {
                    if (result != null) {
                        yVal = result.data.Y;
                    }
                }
            });

            dps.push({
                y: yVal
            });

            chart.render();
        };

        function stop() {
            clearInterval(interval);
            interval = null;
        }

        function start() {
            interval = setInterval(function() { updateChart() }, 10);
        }

        function reset() {
            clearInterval(interval);
            interval = null;
            dps = [];
            chart.options.data[0].dataPoints = dps;
            chart.render();
        }
    </script>
}